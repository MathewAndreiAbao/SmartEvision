import{d as ue,a as g,c as pe,f as y,s as x,t as me,b as lt}from"../chunks/zt7kUNSb.js";import{p as xe,d as h,f as H,o as _e,j as fe,h as ut,a as ge,e as be,s as o,c as a,b as u,g as t,i as z,$ as he,r as e,n as it,t as Q}from"../chunks/D02y27Ec.js";import{i as U}from"../chunks/CyaklKEO.js";import{e as pt,i as mt}from"../chunks/CUJHGDU6.js";import{t as F,a as X,f as zt}from"../chunks/Mk7LNAF3.js";import{h as ye,s as Y,r as we,a as ke}from"../chunks/DG2cR9Zm.js";import{b as Ce}from"../chunks/7bhswH3j.js";import{a as Se,s as $e}from"../chunks/HxVFllSf.js";import{p as De}from"../chunks/t4rw-3Qc.js";import{S as xt,C as Te}from"../chunks/7c_gSnqO.js";import{S as Le}from"../chunks/BlBMRgHN.js";import{C as Re}from"../chunks/HUe4-OGT.js";import{D as Ae}from"../chunks/BHDpGXD2.js";import{getWeekNumber as Wt,calculateCompliance as Z,groupSubmissionsByWeek as Ne,getComplianceBgClass as We,getComplianceClass as je}from"../chunks/rRhaEF5Q.js";var qe=y('<div class="glass-card-static p-6 animate-pulse"><div class="h-4 bg-gray-200 rounded w-24 mb-3"></div> <div class="h-8 bg-gray-200 rounded w-16"></div></div>'),Me=y('<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>'),He=y('<button class="px-3 py-1.5 text-xs font-semibold bg-gov-gold/10 text-gov-gold-dark rounded-lg hover:bg-gov-gold/20 transition-colors"> </button>'),Ie=y('<div class="glass-card-static p-5 mb-8 border-l-4 border-gov-gold"><h3 class="text-sm font-bold text-gov-gold-dark mb-2"> </h3> <div class="flex flex-wrap gap-2"></div></div>'),Pe=y('<div class="flex items-center justify-center h-[260px] text-text-muted"><p>No trend data available yet</p></div>'),Ve=y('<div class="p-10 text-center"><p class="text-text-muted font-medium">No teachers found</p></div>'),Be=y('<tr class="hover:bg-white/40 transition-colors cursor-pointer"><td class="px-6 py-3 font-medium text-text-primary"> </td><td class="px-4 py-3 text-center text-text-secondary"> </td><td class="px-4 py-3 text-center text-gov-green font-semibold"> </td><td class="px-4 py-3 text-center text-gov-gold-dark font-semibold"> </td><td class="px-4 py-3 text-center text-gov-red font-semibold"> </td><td class="px-4 py-3 text-center"><span> </span></td><td class="px-4 py-3 text-right"><button class="text-gov-blue hover:text-gov-blue-dark text-xs font-semibold">View</button></td></tr>'),Ee=y('<div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="border-b border-gray-100"><th class="px-6 py-3 text-left text-xs font-semibold text-text-muted uppercase"><button class="hover:text-text-primary"> </button></th><th class="px-4 py-3 text-center text-xs font-semibold text-text-muted uppercase"><button class="hover:text-text-primary"> </button></th><th class="px-4 py-3 text-center text-xs font-semibold text-text-muted uppercase">Compliant</th><th class="px-4 py-3 text-center text-xs font-semibold text-text-muted uppercase">Late</th><th class="px-4 py-3 text-center text-xs font-semibold text-text-muted uppercase">Non-compliant</th><th class="px-4 py-3 text-center text-xs font-semibold text-text-muted uppercase"><button class="hover:text-text-primary"> </button></th><th class="px-4 py-3 text-right text-xs font-semibold text-text-muted uppercase">Action</th></tr></thead><tbody class="divide-y divide-gray-50"></tbody></table></div>'),Oe=y('<div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-10"><div><!></div> <div><!></div> <div><!></div> <div><!></div></div> <!> <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8"><div class="glass-card-static p-6"><h3 class="text-lg font-bold text-text-primary mb-4">Compliance Heatmap</h3> <!></div> <div class="glass-card-static p-6"><h3 class="text-lg font-bold text-text-primary mb-4">School vs Target</h3> <!></div></div> <div class="glass-card-static overflow-hidden"><div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between flex-wrap gap-3"><h3 class="text-lg font-bold text-text-primary">Teacher Compliance</h3> <input type="text" placeholder="Search teacher..." class="px-4 py-2 text-sm bg-white/60 border border-gray-200 rounded-xl focus:ring-2 focus:ring-gov-blue/30 focus:border-gov-blue outline-none w-56"/></div> <!></div>',1),ze=y('<p class="text-center text-text-muted py-6">No submissions found</p>'),Fe=y('<div class="flex items-center justify-between py-3"><div class="min-w-0"><p class="text-sm font-medium text-text-primary truncate"> </p> <p class="text-xs text-text-muted"> <!></p></div> <div class="flex items-center gap-3 flex-shrink-0"><!> <span class="text-xs text-text-muted"> </span></div></div>'),Ge=y('<div class="divide-y divide-gray-100"></div>'),Qe=y('<div class="grid grid-cols-3 gap-3 mb-4"><div class="text-center p-3 rounded-xl bg-gov-green/10"><p class="text-lg font-bold text-gov-green"> </p> <p class="text-xs text-text-muted">Compliant</p></div> <div class="text-center p-3 rounded-xl bg-gov-gold/10"><p class="text-lg font-bold text-gov-gold-dark"> </p> <p class="text-xs text-text-muted">Late</p></div> <div class="text-center p-3 rounded-xl bg-gov-red/10"><p class="text-lg font-bold text-gov-red"> </p> <p class="text-xs text-text-muted">Non-compliant</p></div></div> <!>',1),Ue=y('<div><div class="mb-8"><h1 class="text-2xl font-bold text-text-primary">School Compliance Monitor</h1> <p class="text-base text-text-secondary mt-1">Track teacher submissions and compliance rates</p></div> <!></div> <!>',1);function da(Ft,Gt){xe(Gt,!0);const Qt=()=>$e(De,"$profile",Ut),[Ut,Jt]=Se();let w=h(H([])),k=h(H([])),jt=h(!0),A=H({totalTeachers:0,overallRate:0,lateCount:0,atRiskCount:0,previousRate:0}),qt=h(H([])),Mt=h(H([])),Ht=h(H([])),_t=h(H([])),It=h(H([])),G=h("rate"),I=h("asc"),nt=h(""),ft=h(!1),tt=h(null),dt=h(H([]));const ct=z(()=>()=>t(w).filter(s=>t(k).filter(l=>l.user_id===s.id).filter(l=>l.compliance_status==="late").length>=2));let gt=null;_e(async()=>{await Pt(),u(jt,!1),gt=Y.channel("school-submissions").on("postgres_changes",{event:"*",schema:"public",table:"submissions"},()=>{Pt()}).subscribe()}),fe(()=>{gt&&Y.removeChannel(gt)});async function Pt(){const s=Qt();if(!s?.school_id)return;const[d,p,l,m]=await Promise.all([Y.from("profiles").select("id, full_name, role, district_id").eq("school_id",s.school_id).eq("role","Teacher").order("full_name"),Y.from("submissions").select("id, user_id, file_name, doc_type, compliance_status, created_at, week_number, profiles!inner(school_id), teaching_loads(subject, grade_level)").eq("profiles.school_id",s.school_id).order("created_at",{ascending:!1}),Y.from("teaching_loads").select("id, user_id, profiles!inner(school_id)").eq("profiles.school_id",s.school_id),Y.from("academic_calendar").select("*").eq("school_year","2025-2026").order("week_number",{ascending:!0})]);u(w,(d.data||[]).map(r=>r),!0);const c=l.data||[],v=t(w)[0]?.district_id||s.district_id;let i=m.data||[];v&&(i=i.filter(r=>r.district_id===v)),u(w,t(w).map(r=>({...r,loadCount:c.filter(b=>b.user_id===r.id).length})),!0),u(k,(p.data||[]).map(r=>r),!0);const N=new Set(t(w).map(r=>r.id));u(k,t(k).filter(r=>N.has(r.user_id)),!0);const _=t(w).reduce((r,b)=>r+(b.loadCount||0),0),C=Wt();i.find(r=>r.week_number===C);const P=Z(t(k),_);A.totalTeachers=t(w).length,A.overallRate=P.rate,A.lateCount=P.Late,A.atRiskCount=t(w).filter(r=>{const b=t(k).filter(V=>V.user_id===r.id);return Z(b,r.loadCount).rate<70&&b.length>0}).length,i.find(r=>r.week_number===C-1);const et=t(k).filter(r=>(r.week_number||Wt(new Date(r.created_at)))===C-1);A.previousRate=Z(et,_).rate,Kt(i);const W=Ne(t(k),_,8,i);u(_t,W.map(r=>r.label),!0),u(It,[{label:"School Compliance",data:W.map(r=>r.rate),color:"#0038A8"},{label:"80% Target",data:W.map(()=>80),color:"#CE1126",dashed:!0}],!0)}function Kt(s=[]){const d=Wt(),p=8,l=[];if(s.length>0){const c=[...s].sort((v,i)=>i.week_number-v.week_number).slice(0,p).reverse();for(const v of c)l.push({week:v.week_number,label:`W${v.week_number}`,deadline:v.deadline_date})}else for(let c=p-1;c>=0;c--){const v=d-c;v>=1&&l.push({week:v,label:`W${v}`,deadline:null})}u(Mt,l,!0),u(qt,t(w).map(c=>c.full_name),!0);const m=[];for(const c of t(w)){const v=t(k).filter(i=>i.user_id===c.id);for(const i of l){const N=v.filter(C=>C.week_number===i.week),_=Z(N,c.loadCount,c.loadCount,i.deadline);m.push({row:c.full_name,week:i.week,weekLabel:i.label,rate:_.rate,count:N.length,tooltip:`${c.full_name} — ${i.label}: ${_.rate}% (${_.Compliant} compliant, ${_.Late} late, ${_.NonCompliant} non-compliant)`})}}u(Ht,m,!0)}const Vt=z(()=>()=>{let s=t(w).map(d=>{const p=t(k).filter(m=>m.user_id===d.id),l=Z(p,d.loadCount);return{...d,...l}});if(t(nt).trim()){const d=t(nt).toLowerCase();s=s.filter(p=>p.full_name.toLowerCase().includes(d))}return s.sort((d,p)=>{const l=d[t(G)],m=p[t(G)];return typeof l=="number"&&typeof m=="number"?t(I)==="asc"?l-m:m-l:t(I)==="asc"?String(l).localeCompare(String(m)):String(m).localeCompare(String(l))}),s});function bt(s){t(G)===s?u(I,t(I)==="asc"?"desc":"asc",!0):(u(G,s,!0),u(I,s==="full_name"?"asc":"desc",!0))}function ht(s){u(tt,s,!0),u(dt,t(k).filter(d=>d.user_id===s.id).slice(0,20),!0),u(ft,!0)}function Xt(s){return new Date(s).toLocaleDateString("en-PH",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}var Bt=Ue();ye("d819pb",s=>{be(()=>{he.title="School Monitoring — Smart E-VISION"})});var yt=ut(Bt),Yt=o(a(yt),2);{var Zt=s=>{var d=Me();pt(d,20,()=>Array(4),mt,(p,l)=>{var m=qe();g(p,m)}),e(d),g(s,d)},te=s=>{var d=Oe(),p=ut(d),l=a(p),m=a(l);xt(m,{icon:"Users",get value(){return A.totalTeachers},label:"Total Teachers"}),e(l);var c=o(l,2),v=a(c);xt(v,{icon:"Activity",get value(){return`${A.overallRate??""}%`},label:"School Rate",color:"from-gov-green to-gov-green-dark"}),e(c);var i=o(c,2),N=a(i);xt(N,{icon:"Clock",get value(){return A.lateCount},label:"Late Submissions",color:"from-gov-gold to-gov-gold-dark"}),e(i);var _=o(i,2),C=a(_);xt(C,{icon:"ShieldAlert",get value(){return A.atRiskCount},label:"Compliance Leads",color:"from-gov-red to-red-700"}),e(_),e(p);var P=o(p,2);{var et=n=>{var f=Ie(),$=a(f),T=a($);e($);var E=o($,2);pt(E,21,()=>t(ct)(),mt,(j,L)=>{var q=He(),O=a(q,!0);e(q),Q(()=>x(O,t(L).full_name)),lt("click",q,()=>ht(t(L))),g(j,q)}),e(E),e(f),Q((j,L)=>x(T,`Attention: ${j??""} teacher${L??""} with ≥2 late submissions`),[()=>t(ct)().length,()=>t(ct)().length>1?"s":""]),F(1,f,()=>zt,()=>({duration:500,delay:400})),g(n,f)},W=z(()=>t(ct)().length>0);U(P,n=>{t(W)&&n(et)})}var r=o(P,2),b=a(r),at=o(a(b),2);Re(at,{get rows(){return t(qt)},get weeks(){return t(Mt)},get cells(){return t(Ht)},onCellClick:(n,f)=>{const $=t(w).find(T=>T.full_name===n);$&&ht($)}}),e(b);var V=o(b,2),wt=o(a(V),2);{var kt=n=>{Te(n,{get labels(){return t(_t)},get datasets(){return t(It)},height:260})},Ct=n=>{var f=Pe();g(n,f)};U(wt,n=>{t(_t).length>0?n(kt):n(Ct,!1)})}e(V),e(r);var rt=o(r,2),D=a(rt),B=o(a(D),2);we(B),e(D);var St=o(D,2);{var S=n=>{var f=Ve();g(n,f)},st=z(()=>t(Vt)().length===0),ot=n=>{var f=Ee(),$=a(f),T=a($),E=a(T),j=a(E),L=a(j),q=a(L);e(L),e(j);var O=o(j),J=a(O),$t=a(J);e(J),e(O);var R=o(O,4),K=a(R),ae=a(K);e(K),e(R),it(),e(E),e(T);var Et=o(T);pt(Et,21,()=>t(Vt)(),mt,(re,M)=>{var vt=Be(),Dt=a(vt),se=a(Dt,!0);e(Dt);var Tt=o(Dt),oe=a(Tt,!0);e(Tt);var Lt=o(Tt),le=a(Lt,!0);e(Lt);var Rt=o(Lt),ie=a(Rt,!0);e(Rt);var At=o(Rt),ne=a(At,!0);e(At);var Ot=o(At),Nt=a(Ot),de=a(Nt);e(Nt),e(Ot),it(),e(vt),Q((ce,ve)=>{x(se,t(M).full_name),x(oe,t(M).total),x(le,t(M).Compliant),x(ie,t(M).Late),x(ne,t(M).NonCompliant),ke(Nt,1,`inline-block px-2.5 py-1 rounded-full text-xs font-bold ${ce??""} ${ve??""}`),x(de,`${t(M).rate??""}%`)},[()=>We(t(M).rate),()=>je(t(M).rate)]),lt("click",vt,()=>ht(t(M))),g(re,vt)}),e(Et),e($),e(f),Q(()=>{x(q,`Teacher ${t(G)==="full_name"?t(I)==="asc"?"(Asc)":"(Desc)":""}`),x($t,`Total ${t(G)==="total"?t(I)==="asc"?"(Asc)":"(Desc)":""}`),x(ae,`Rate ${t(G)==="rate"?t(I)==="asc"?"(Asc)":"(Desc)":""}`)}),lt("click",L,()=>bt("full_name")),lt("click",J,()=>bt("total")),lt("click",K,()=>bt("rate")),g(n,f)};U(St,n=>{t(st)?n(S):n(ot,!1)})}e(rt),F(1,l,()=>X,()=>({y:20,duration:400})),F(1,c,()=>X,()=>({y:20,duration:400,delay:100})),F(1,i,()=>X,()=>({y:20,duration:400,delay:200})),F(1,_,()=>X,()=>({y:20,duration:400,delay:300})),F(1,b,()=>X,()=>({y:20,duration:500,delay:500})),F(1,V,()=>X,()=>({y:20,duration:500,delay:600})),Ce(B,()=>t(nt),n=>u(nt,n)),F(1,rt,()=>zt,()=>({duration:500,delay:700})),g(s,d)};U(Yt,s=>{t(jt)?s(Zt):s(te,!1)})}e(yt);var ee=o(yt,2);{let s=z(()=>t(tt)?`Submissions: ${t(tt).full_name}`:"Teacher Details");Ae(ee,{get isOpen(){return t(ft)},get title(){return t(s)},onClose:()=>{u(ft,!1),u(tt,null)},children:(d,p)=>{var l=pe(),m=ut(l);{var c=v=>{const i=z(()=>Z(t(dt)));var N=Qe(),_=ut(N),C=a(_),P=a(C),et=a(P,!0);e(P),it(2),e(C);var W=o(C,2),r=a(W),b=a(r,!0);e(r),it(2),e(W);var at=o(W,2),V=a(at),wt=a(V,!0);e(V),it(2),e(at),e(_);var kt=o(_,2);{var Ct=D=>{var B=ze();g(D,B)},rt=D=>{var B=Ge();pt(B,21,()=>t(dt),mt,(St,S)=>{const st=z(()=>Array.isArray(t(S).teaching_loads)?t(S).teaching_loads[0]:t(S).teaching_loads);var ot=Fe(),n=a(ot),f=a(n),$=a(f,!0);e(f);var T=o(f,2),E=a(T),j=o(E);{var L=R=>{var K=me();Q(()=>x(K,`· ${t(st).subject??""} - Gr. ${t(st).grade_level??""}`)),g(R,K)};U(j,R=>{t(st)&&R(L)})}e(T),e(n);var q=o(n,2),O=a(q);{let R=z(()=>t(S).compliance_status==="on-time"||t(S).compliance_status==="compliant"?"compliant":t(S).compliance_status==="late"?"late":"non-compliant");Le(O,{get status(){return t(R)},size:"sm"})}var J=o(O,2),$t=a(J,!0);e(J),e(q),e(ot),Q(R=>{x($,t(S).file_name),x(E,`${t(S).doc_type??""} `),x($t,R)},[()=>Xt(t(S).created_at)]),g(St,ot)}),e(B),g(D,B)};U(kt,D=>{t(dt).length===0?D(Ct):D(rt,!1)})}Q(()=>{x(et,t(i).Compliant),x(b,t(i).Late),x(wt,t(i).NonCompliant)}),g(v,N)};U(m,v=>{t(tt)&&v(c)})}g(d,l)},$$slots:{default:!0}})}g(Ft,Bt),ge(),Jt()}ue(["click"]);export{da as component};
