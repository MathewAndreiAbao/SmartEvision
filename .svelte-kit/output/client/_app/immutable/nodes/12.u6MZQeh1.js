import{d as Ut,a as D,c as Xt,f as q,s as y,b as ct}from"../chunks/zt7kUNSb.js";import{p as Yt,d as f,f as k,o as Zt,j as te,h as vt,t as U,a as ee,e as ae,s,c as a,b as c,g as t,i as pt,$ as re,r as e,n as mt}from"../chunks/D02y27Ec.js";import{i as Lt}from"../chunks/CyaklKEO.js";import{e as ut,i as ft}from"../chunks/CUJHGDU6.js";import{t as j,a as z,f as se}from"../chunks/Mk7LNAF3.js";import{h as oe,s as N,r as ie,a as le}from"../chunks/DG2cR9Zm.js";import{b as de}from"../chunks/7bhswH3j.js";import{a as ne,s as ce}from"../chunks/HxVFllSf.js";import{p as ve}from"../chunks/t4rw-3Qc.js";import{S as X,C as pe}from"../chunks/7c_gSnqO.js";import{S as me}from"../chunks/BlBMRgHN.js";import{C as ue}from"../chunks/HUe4-OGT.js";import{D as fe}from"../chunks/BHDpGXD2.js";import{markMissingSubmissions as ge,getWeekNumber as gt,calculateCompliance as Y,getSubmissionWeek as xt,groupSubmissionsByWeek as xe,getComplianceBgClass as _e,getComplianceClass as be}from"../chunks/rRhaEF5Q.js";var he=q('<div class="glass-card-static p-8 animate-pulse text-center"><div class="h-4 bg-gray-200 rounded w-24 mx-auto mb-4"></div> <div class="h-10 bg-gray-200 rounded w-16 mx-auto"></div></div>'),ye=q('<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>'),we=q('<tr class="hover:bg-white/40 transition-colors cursor-pointer"><td class="px-6 py-4 font-medium text-text-primary"> </td><td class="px-4 py-4 text-center text-gov-green font-semibold"> </td><td class="px-4 py-4 text-center text-gov-gold-dark font-semibold"> </td><td class="px-4 py-4 text-center text-gov-red font-semibold"> </td><td class="px-4 py-4 text-center"><span> </span></td><td class="px-6 py-4 text-right"><button class="text-gov-blue hover:underline font-semibold text-xs">Details</button></td></tr>'),ke=q('<div class="grid grid-cols-2 lg:grid-cols-4 gap-6"><div><!></div> <div><!></div> <div><!></div> <div><!></div></div> <div class="grid grid-cols-1 xl:grid-cols-2 gap-6"><div class="glass-card-static p-6"><h3 class="text-lg font-bold text-text-primary mb-4">School Performance Heatmap</h3> <!></div> <div class="glass-card-static p-6"><h3 class="text-lg font-bold text-text-primary mb-4">District-Wide Trend</h3> <div class="h-[280px]"><!></div></div></div> <div class="glass-card-static overflow-hidden"><div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between flex-wrap gap-4"><h3 class="text-lg font-bold text-text-primary">School Rankings</h3> <input type="text" placeholder="Search school..." class="px-4 py-2 text-sm bg-white/60 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-gov-blue/30 w-64"/></div> <div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-gray-50/50 text-left border-b border-gray-100"><th class="px-6 py-3 font-semibold text-text-muted cursor-pointer hover:text-text-primary">School</th><th class="px-4 py-3 text-center font-semibold text-text-muted">Compliant</th><th class="px-4 py-3 text-center font-semibold text-text-muted">Late</th><th class="px-4 py-3 text-center font-semibold text-text-muted">Missing</th><th class="px-4 py-3 text-center font-semibold text-text-muted cursor-pointer hover:text-text-primary">Rate</th><th class="px-6 py-3 text-right font-semibold text-text-muted">Action</th></tr></thead><tbody class="divide-y divide-gray-50"></tbody></table></div></div>',1),Ce=q('<div class="py-3 flex items-center justify-between"><div class="min-w-0 pr-4"><p class="text-sm font-medium text-text-primary truncate"> </p> <p class="text-xs text-text-muted"> </p></div> <!></div>'),Se=q('<div class="space-y-4"><div class="grid grid-cols-3 gap-3"><div class="bg-gov-blue/5 p-3 rounded-lg text-center"><p class="text-xs text-text-muted mb-1">Expectation</p> <p class="text-lg font-bold text-gov-blue"> </p></div> <div class="bg-gov-green/5 p-3 rounded-lg text-center"><p class="text-xs text-text-muted mb-1">Compliance</p> <p class="text-lg font-bold text-gov-green"> </p></div> <div class="bg-gov-red/5 p-3 rounded-lg text-center"><p class="text-xs text-text-muted mb-1">Missing</p> <p class="text-lg font-bold text-gov-red"> </p></div></div> <div class="divide-y divide-gray-100"></div></div>'),$e=q('<div class="space-y-10"><div class="flex flex-col md:flex-row md:items-end justify-between gap-4"><div><h1 class="text-3xl font-black text-text-primary tracking-tight">District Oversight</h1> <p class="text-base text-text-secondary mt-1 font-medium">Monitoring performance across <span class="font-bold text-gov-blue"> </span> in the district</p></div></div> <!></div> <!>',1);function Pe(Mt,jt){Yt(jt,!0);const Z=()=>ce(ve,"$profile",Nt),[Nt,qt]=ne();let C=f(k([])),B=f(k([])),_t=f(!0),E=f(k({totalSchools:0,overallRate:0,lateCount:0,atRiskCount:0,previousRate:0})),bt=f(k([])),ht=f(k([])),yt=f(k([])),wt=f(k([])),kt=f(k([])),F=f("rate"),H=f("desc"),Q=f(""),tt=f(!1),A=f(null),Ct=f(k([])),et=null;Zt(async()=>{await at(),Z()?.district_id&&ge(N,"2025-2026",Z().district_id).then(o=>{o>0&&at()}),c(_t,!1),et=N.channel("district-monitoring").on("postgres_changes",{event:"*",schema:"public",table:"submissions"},()=>at()).subscribe()}),te(()=>{et&&N.removeChannel(et)});async function at(){const o=Z();if(!o?.district_id)return;const{data:l}=await N.from("schools").select("id, name, district_id").eq("district_id",o.district_id).order("name");if(!l)return;const v=l.map(r=>r.id),{data:d}=await N.from("submissions").select(`
                id, user_id, file_name, doc_type, compliance_status, created_at, week_number,
                profiles!inner(school_id)
            `).in("profiles.school_id",v).order("created_at",{ascending:!1}),{data:m}=await N.from("teaching_loads").select("id, profiles!inner(school_id)").in("profiles.school_id",v),{data:i}=await N.from("academic_calendar").select("*").eq("school_year","2025-2026").order("week_number",{ascending:!0}),u=(i||[]).filter(r=>r.district_id===o.district_id||!r.district_id);c(C,l.map(r=>{const h=(d||[]).filter(p=>(Array.isArray(p.profiles)?p.profiles[0]:p.profiles)?.school_id===r.id),$=(m||[]).filter(p=>(Array.isArray(p.profiles)?p.profiles[0]:p.profiles)?.school_id===r.id).length,I=gt();u.find(p=>p.week_number===I);const W=Y(h,$);return{...r,...W,loadCount:$}}),!0),c(B,(d||[]).map(r=>{const h=Array.isArray(r.profiles)?r.profiles[0]:r.profiles;return{...r,school_id:h?.school_id,week_number:xt(r)}}),!0);const n=t(C).reduce((r,h)=>r+(h.loadCount||0),0),b=gt();u.find(r=>r.week_number===b);const g=Y(t(B),n);u.find(r=>r.week_number===b-1);const S=t(B).filter(r=>xt(r)===b-1),R=Y(S,n);c(E,{totalSchools:t(C).length,overallRate:g.rate,lateCount:g.Late,atRiskCount:t(C).filter(r=>(r.rate||0)<70).length,previousRate:R.rate},!0),Bt(u);const _=xe(t(B),n,8,u);c(wt,_.map(r=>r.label),!0),c(kt,[{label:"District Compliance",data:_.map(r=>r.rate),color:"#0038A8"},{label:"80% Target",data:_.map(()=>80),color:"#CE1126",dashed:!0}],!0)}function Bt(o){gt();const v=[],d=[...o].sort((i,u)=>u.week_number-i.week_number).slice(0,8).reverse();for(const i of d)v.push({week:i.week_number,label:`W${i.week_number}`,deadline:i.deadline_date});c(ht,v,!0),c(bt,t(C).map(i=>i.name),!0);const m=[];for(const i of t(C)){const u=t(B).filter(n=>n.school_id===i.id);for(const n of v){const b=u.filter(S=>xt(S)===n.week),g=Y(b,i.loadCount,i.loadCount,n.deadline);m.push({row:i.name,week:n.week,rate:g.rate,tooltip:`${i.name} — ${n.label}: ${g.rate}%`})}}c(yt,m,!0)}const Et=pt(()=>()=>{let o=[...t(C)];if(t(Q).trim()){const l=t(Q).toLowerCase();o=o.filter(v=>v.name.toLowerCase().includes(l))}return o.sort((l,v)=>{const d=l[t(F)],m=v[t(F)];return typeof d=="number"?t(H)==="asc"?d-m:m-d:t(H)==="asc"?String(d).localeCompare(String(m)):String(m).localeCompare(String(d))}),o});function St(o){c(A,o,!0),c(Ct,t(B).filter(l=>l.school_id===o.id).slice(0,50),!0),c(tt,!0)}var $t=$e();oe("1thoarh",o=>{ae(()=>{re.title="District Monitoring — Smart E-VISION"})});var rt=vt($t),st=a(rt),Dt=a(st),At=s(a(Dt),2),Rt=s(a(At)),Ht=a(Rt);e(Rt),mt(),e(At),e(Dt),e(st);var It=s(st,2);{var Ot=o=>{var l=ye();ut(l,20,()=>Array(4),ft,(v,d)=>{var m=he();D(v,m)}),e(l),D(o,l)},Pt=o=>{var l=ke(),v=vt(l),d=a(v),m=a(d);X(m,{icon:"School",get value(){return t(E).totalSchools},label:"Active Schools"}),e(d);var i=s(d,2),u=a(i);X(u,{icon:"Activity",get value(){return`${t(E).overallRate??""}%`},label:"District Rate",color:"from-gov-green to-gov-green-dark"}),e(i);var n=s(i,2),b=a(n);X(b,{icon:"Clock",get value(){return t(E).lateCount},label:"Late Submissions",color:"from-gov-gold to-gov-gold-dark"}),e(n);var g=s(n,2),S=a(g);X(S,{icon:"ShieldAlert",get value(){return t(E).atRiskCount},label:"Alert Schools",color:"from-gov-red to-red-700"}),e(g),e(v);var R=s(v,2),_=a(R),r=s(a(_),2);ue(r,{get rows(){return t(bt)},get weeks(){return t(ht)},get cells(){return t(yt)},onCellClick:M=>{const x=t(C).find(V=>V.name===M);x&&St(x)}}),e(_);var h=s(_,2),$=s(a(h),2),I=a($);pe(I,{get labels(){return t(wt)},get datasets(){return t(kt)},height:280}),e($),e(h),e(R);var W=s(R,2),p=a(W),O=s(a(p),2);ie(O),e(p);var w=s(p,2),P=a(w),L=a(P),T=a(L),G=a(T),J=s(G,4);mt(),e(T),e(L);var K=s(L);ut(K,21,()=>t(Et)(),ft,(M,x)=>{var V=we(),ot=a(V),Vt=a(ot,!0);e(ot);var it=s(ot),zt=a(it,!0);e(it);var lt=s(it),Ft=a(lt,!0);e(lt);var dt=s(lt),Qt=a(dt,!0);e(dt);var Wt=s(dt),nt=a(Wt),Gt=a(nt);e(nt),e(Wt),mt(),e(V),U((Jt,Kt)=>{y(Vt,t(x).name),y(zt,t(x).Compliant),y(Ft,t(x).Late),y(Qt,t(x).NonCompliant),le(nt,1,`px-2.5 py-1 rounded-full text-xs font-bold ${Jt??""} ${Kt??""}`),y(Gt,`${t(x).rate??""}%`)},[()=>_e(t(x).rate||0),()=>be(t(x).rate||0)]),ct("click",V,()=>St(t(x))),D(M,V)}),e(K),e(P),e(w),e(W),j(1,d,()=>z,()=>({y:20,duration:400})),j(1,i,()=>z,()=>({y:20,duration:400,delay:100})),j(1,n,()=>z,()=>({y:20,duration:400,delay:200})),j(1,g,()=>z,()=>({y:20,duration:400,delay:300})),j(1,_,()=>z,()=>({y:20,duration:500,delay:400})),j(1,h,()=>z,()=>({y:20,duration:500,delay:500})),de(O,()=>t(Q),M=>c(Q,M)),ct("click",G,()=>{c(F,"name"),c(H,t(H)==="asc"?"desc":"asc",!0)}),ct("click",J,()=>{c(F,"rate"),c(H,t(H)==="asc"?"desc":"asc",!0)}),j(1,W,()=>se,()=>({duration:500,delay:600})),D(o,l)};Lt(It,o=>{t(_t)?o(Ot):o(Pt,!1)})}e(rt);var Tt=s(rt,2);{let o=pt(()=>t(A)?`School Submissions: ${t(A).name}`:"School Details");fe(Tt,{get isOpen(){return t(tt)},get title(){return t(o)},onClose:()=>c(tt,!1),children:(l,v)=>{var d=Xt(),m=vt(d);{var i=u=>{var n=Se(),b=a(n),g=a(b),S=s(a(g),2),R=a(S,!0);e(S),e(g);var _=s(g,2),r=s(a(_),2),h=a(r);e(r),e(_);var $=s(_,2),I=s(a($),2),W=a(I,!0);e(I),e($),e(b);var p=s(b,2);ut(p,21,()=>t(Ct),ft,(O,w)=>{var P=Ce(),L=a(P),T=a(L),G=a(T,!0);e(T);var J=s(T,2),K=a(J);e(J),e(L);var M=s(L,2);{let x=pt(()=>t(w).compliance_status==="late"?"late":t(w).compliance_status==="non-compliant"||t(w).compliance_status==="missing"?"non-compliant":"compliant");me(M,{get status(){return t(x)},size:"sm"})}e(P),U(()=>{y(G,t(w).file_name),y(K,`${t(w).doc_type??""} • Week ${t(w).week_number??""}`)}),D(O,P)}),e(p),e(n),U(()=>{y(R,t(A).loadCount),y(h,`${t(A).rate??""}%`),y(W,t(A).NonCompliant)}),D(u,n)};Lt(m,u=>{t(A)&&u(i)})}D(l,d)},$$slots:{default:!0}})}U(()=>y(Ht,`${t(E).totalSchools??""} schools`)),D(Mt,$t),ee(),qt()}Ut(["click"]);export{Pe as component};
