import{w as H}from"./D02y27Ec.js";import{s as f}from"./DG2cR9Zm.js";import{a as p}from"./0ZKSTxe_.js";function u(e){return new Promise((n,t)=>{e.oncomplete=e.onsuccess=()=>n(e.result),e.onabort=e.onerror=()=>t(e.error)})}function P(e,n){let t;const o=()=>{if(t)return t;const a=indexedDB.open(e);return a.onupgradeneeded=()=>a.result.createObjectStore(n),t=u(a),t.then(l=>{l.onclose=()=>t=void 0},()=>{}),t};return(a,l)=>o().then(r=>l(r.transaction(n,a).objectStore(n)))}let b;function h(){return b||(b=P("keyval-store","keyval")),b}function C(e,n=h()){return n("readonly",t=>u(t.get(e)))}function I(e,n,t=h()){return t("readwrite",o=>(o.put(n,e),u(o.transaction)))}function k(e,n=h()){return n("readwrite",t=>(t.delete(e),u(t.transaction)))}function z(e,n){return e.openCursor().onsuccess=function(){this.result&&(n(this.result),this.result.continue())},u(e.transaction)}function L(e=h()){return e("readonly",n=>{if(n.getAllKeys)return u(n.getAllKeys());const t=[];return z(n,o=>t.push(o.key)).then(()=>t)})}const A=H(0),j="cached_docs_";async function F(e,n){await I(`${j}${e}`,n)}async function q(e){return await C(`${j}${e}`)}async function B(){try{if(!navigator.onLine)return 0;const{data:e,error:n}=await f.from("submissions").select(`
                file_hash, file_name, doc_type, compliance_status, created_at, 
                file_size, week_number, subject, school_year,
                profiles:user_id ( full_name, schools:school_id ( name ) ),
                teaching_loads ( subject, grade_level )
            `).not("file_hash","like","missing_%").order("created_at",{ascending:!1}).limit(500);if(n||!e)return 0;let t=0;for(const o of e){const a=o.profiles,l=o.teaching_loads,r={file_name:o.file_name,doc_type:o.doc_type,compliance_status:o.compliance_status,created_at:o.created_at,file_size:o.file_size,week_number:o.week_number,subject:o.subject,school_year:o.school_year,teacher_name:a?.full_name||null,school_name:a?.schools?.name||null,teaching_load_subject:l?.subject||null,teaching_load_grade:l?.grade_level||null};await F(o.file_hash,r),t++}return console.log(`[offline] Pre-cached ${t} document hashes for offline verification`),t}catch(e){return console.warn("[offline] preloadVerificationHashes error:",e),0}}const D="sync_queue_";async function Q(e){const n=`${D}${e.timestamp}_${e.fileHash.slice(0,8)}`;await I(n,e),await S()}async function K(){return(await L()).filter(n=>String(n).startsWith(D)).length}async function S(){const e=await K();A.set(e)}let v=!1;async function E(){if(typeof navigator<"u"&&!navigator.onLine)return!1;try{const e=new AbortController,n=setTimeout(()=>e.abort(),5e3),t=await fetch(window.location.origin,{method:"HEAD",cache:"no-store",signal:e.signal});return clearTimeout(n),t.ok||t.status===405}catch(e){return console.warn("[offline] Connection check failed:",e),!1}}async function m(e=!1){if(!(e?!0:await E()))return{success:0,failed:0};if(v&&!e)return console.log("[offline] processQueue skipped: Already syncing"),{success:0,failed:0};const o=(await L()).filter(r=>String(r).startsWith(D));if(o.length===0)return{success:0,failed:0};console.log(`[offline] Found ${o.length} items to sync...`),v=!0;let a=0,l=0;p("info",`Syncing ${o.length} offline file(s)...`);try{for(const r of o){if(!e&&!await E()){console.log("[offline] Connection lost during sync. Pausing...");break}const i=await C(r);if(!i){console.warn(`[offline] Found ghost key ${r}, removing...`),await k(r);continue}try{const{data:y}=await f.from("submissions").select("id").eq("file_hash",i.fileHash).maybeSingle();if(y){console.warn(`[offline] Skipping duplicate file: ${i.fileName}`),await k(r),p("warning",`Skipped duplicate: ${i.fileName}`);continue}const{error:$}=await f.storage.from("submissions").upload(i.filePath,i.pdfBytes,{contentType:"application/pdf",upsert:!1});if($)throw new Error(`Upload failed: ${$.message}`);let _;if(i.options.calendarId){const{data:s}=await f.from("academic_calendar").select("deadline_date").eq("id",i.options.calendarId).single();s?.deadline_date&&(_=new Date(s.deadline_date))}else if(i.options.weekNumber){const{data:s}=await f.from("profiles").select("district_id").eq("id",i.options.userId).single();if(s?.district_id){const{data:d}=await f.from("academic_calendar").select("deadline_date").eq("district_id",s.district_id).eq("week_number",i.options.weekNumber).maybeSingle();d?.deadline_date&&(_=new Date(d.deadline_date))}}const g=new Date;let c="non-compliant";if(_){const s=new Date(_);if(s.setHours(23,59,59,999),g<=s)c="compliant";else{const d=new Date(s);d.setDate(d.getDate()+1),g<=d?c="late":c="non-compliant"}}else{const s=g.getDay();s===1||s===0?c="compliant":s===2?c="late":c="non-compliant"}const{error:w}=await f.from("submissions").insert({user_id:i.options.userId,file_name:i.fileName,file_path:i.filePath,file_hash:i.fileHash,file_size:i.fileSize,doc_type:i.options.docType||"Unknown",week_number:i.options.weekNumber,school_year:i.options.schoolYear||"2025-2026",subject:i.options.subject,calendar_id:i.options.calendarId||null,teaching_load_id:i.options.teachingLoadId||null,compliance_status:c});if(w)throw console.error("[pipeline] DB insert error:",w),new Error(`DB Insert failed: ${w.message}`);await k(r),await S(),a++,console.log(`[offline] Successfully synced: ${i.fileName}`)}catch(y){console.error(`[offline] Failed to sync ${i.fileName}:`,y),l++}}}finally{v=!1}return a>0&&p("success",`Synced ${a} file(s) successfully!`),l>0&&p("error",`Failed to sync ${l} file(s). Will retry automatically.`),{success:a,failed:l}}function U(){typeof window>"u"||(window.addEventListener("online",()=>{console.log('[offline] Network "online" event detected.'),p("info","Connection restored. Attempting verification..."),setTimeout(()=>{m()},3e3)}),setInterval(()=>{navigator.onLine&&m()},3e4),S(),navigator.onLine&&setTimeout(()=>{console.log("[offline] Initial load check..."),m()},5e3),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&navigator.onLine&&m()}),window.addEventListener("focus",()=>{navigator.onLine&&m()}))}export{F as cacheVerifiedDoc,Q as enqueue,K as getQueueSize,U as initOfflineSync,q as lookupOfflineDoc,A as pendingSyncCount,B as preloadVerificationHashes,m as processQueue,S as updatePendingCount};
