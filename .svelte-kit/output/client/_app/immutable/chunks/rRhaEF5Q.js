function x(e){let n=0,i=0,u=0;for(const o of e){const r=(o.compliance_status||"non-compliant").toLowerCase().trim();r==="compliant"||r==="on-time"?n++:r==="late"?i++:u++}return{compliant:n,late:i,nonCompliant:u,total:n+i+u}}function p(e,n=0,i,u){const o=x(e),r=o.total,c=r>0?Math.min(100,Math.round(o.compliant/r*100)):0;return{Compliant:o.compliant,Late:o.late,NonCompliant:o.nonCompliant,totalUploaded:r,expected:i!==void 0?i:n,rate:c}}const M=new Date("2025-08-01");function h(e=new Date){const n=e.getTime()-M.getTime(),i=Math.ceil(n/(1e3*60*60*24*7));return Math.max(1,i)}function v(e){return e>=80?"text-gov-green":e>=50?"text-gov-gold-dark":"text-gov-red"}function N(e){return e>=80?"bg-gov-green/15":e>=50?"bg-gov-gold/15":"bg-gov-red/15"}function W(e){if(!e)return"non-compliant";const n=e.toLowerCase().trim();return n==="compliant"||n==="on-time"?"compliant":n==="late"?"late":n==="non-compliant"||n==="missing"||n==="non compliant"?"non-compliant":n}function D(e,n=0,i=8,u=[]){const o=[];if(u.length>0){const c=[...u].sort((a,l)=>l.week_number-a.week_number).slice(0,i);for(const a of c){const l=e.filter(_=>_.week_number===a.week_number),s=p(l,n);o.push({week:a.week_number,label:`W${a.week_number}`,Compliant:s.Compliant,Late:s.Late,NonCompliant:s.NonCompliant,rate:s.rate,docs:l.length})}return o.reverse()}const r=h();for(let c=i-1;c>=0;c--){const a=r-c;if(a<1)continue;const l=e.filter(_=>_.week_number?_.week_number===a:h(new Date(_.created_at))===a),s=p(l,n);o.push({week:a,label:`W${a}`,Compliant:s.Compliant,Late:s.Late,NonCompliant:s.NonCompliant,rate:s.rate,docs:l.length})}return o}function L(e){return e.week_number?e.week_number:e.created_at?h(new Date(e.created_at)):h()}async function q(e,n="2025-2026",i){const u=new Date;let o=0;try{let r=e.from("academic_calendar").select("id, week_number, deadline_date").eq("school_year",n).lt("deadline_date",u.toISOString()).order("week_number",{ascending:!0});i&&(r=r.eq("district_id",i));const{data:c,error:a}=await r;if(a||!c||c.length===0)return 0;let l=e.from("profiles").select("id, full_name, school_id").eq("role","Teacher");if(i){const{data:t}=await e.from("schools").select("id").eq("district_id",i);if(t&&t.length>0){const m=t.map(d=>d.id);l=l.in("school_id",m)}}const{data:s,error:_}=await l;if(_||!s||s.length===0)return 0;const k=c.map(t=>t.week_number),b=s.map(t=>t.id),{data:C}=await e.from("submissions").select("user_id, week_number").in("user_id",b).in("week_number",k).eq("school_year",n),S=new Set((C||[]).map(t=>`${t.user_id}_${t.week_number}`)),w=[];for(const t of s)for(const m of c){const d=`${t.id}_${m.week_number}`;S.has(d)||w.push({user_id:t.id,file_name:`[MISSING] Week ${m.week_number}`,file_path:`missing/${t.id}/week_${m.week_number}`,file_hash:`missing_${t.id}_${m.week_number}_${n}`,file_size:0,doc_type:"Unknown",week_number:m.week_number,school_year:n,calendar_id:m.id,compliance_status:"non-compliant"})}if(w.length>0)for(let t=0;t<w.length;t+=50){const m=w.slice(t,t+50),d=m.map(f=>f.file_hash),{data:$}=await e.from("submissions").select("file_hash").in("file_hash",d),y=new Set(($||[]).map(f=>f.file_hash)),g=m.filter(f=>!y.has(f.file_hash));if(g.length>0){const{error:f}=await e.from("submissions").insert(g);f?console.warn("[compliance] Batch insert error:",f.message):o+=g.length}}o>0&&console.log(`[compliance] Marked ${o} missing submissions as non-compliant`)}catch(r){console.error("[compliance] markMissingSubmissions error:",r)}return o}export{p as calculateCompliance,x as countSubmissionsByStatus,N as getComplianceBgClass,v as getComplianceClass,L as getSubmissionWeek,h as getWeekNumber,D as groupSubmissionsByWeek,q as markMissingSubmissions,W as normalizeComplianceStatus};
